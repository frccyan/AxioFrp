name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: AxioFrp v${{ steps.version.outputs.VERSION }}
          body: |
            ## AxioFrp v${{ steps.version.outputs.VERSION }}
            
            ### ğŸš€ æ–°ç‰¹æ€§
            - ğŸ›ï¸ ç®¡ç†åå°é…ç½®ç³»ç»Ÿ
            - ğŸ“Š å®æ—¶é…ç½®æ›´æ–°
            - ğŸ“§ é‚®ä»¶é…ç½®åœ¨çº¿æµ‹è¯•
            - ğŸ“ˆ é…ç½®å†å²å’Œå›æ»š
            
            ### ğŸ³ Docker é•œåƒ
            - **Backend**: `ghcr.io/frccyan/AxioFrp-backend:v${{ steps.version.outputs.VERSION }}`
            - **Frontend**: `ghcr.io/frccyan/AxioFrp-frontend:v${{ steps.version.outputs.VERSION }}`
            
            ### ğŸš€ å¿«é€Ÿéƒ¨ç½²
            ```bash
            # ä½¿ç”¨ Docker Compose
            curl -fsSL https://raw.githubusercontent.com/frccyan/AxioFrp/main/docker-compose.yml -o docker-compose.yml
            
            # è®¾ç½®ç‰ˆæœ¬
            sed -i "s/:latest/:v${{ steps.version.outputs.VERSION }}/g" docker-compose.yml
            
            # å¯åŠ¨æœåŠ¡
            docker-compose up -d
            ```
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            - å®Œæ•´çš„ç®¡ç†åå°é…ç½®ç³»ç»Ÿ
            - ä¼˜åŒ–çš„Dockeræ„å»ºæµç¨‹
            - GitHub Actionsè‡ªåŠ¨åŒ–CI/CD
            - å¢å¼ºçš„å®‰å…¨æ€§å’Œæ€§èƒ½
          draft: false
          prerelease: false

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/frccyan/AxioFrp-backend:latest
            ghcr.io/frccyan/AxioFrp-backend:v${{ steps.version.outputs.VERSION }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ghcr.io/frccyan/AxioFrp-frontend:latest
            ghcr.io/frccyan/AxioFrp-frontend:v${{ steps.version.outputs.VERSION }}